<!DOCTYPE html>
<html>
<head>
  <title>Wardiya</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 40px auto;
      padding: 20px;
    }
    h1 {
      text-align: center;
    }
    .section {
      margin: 30px 0;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    input[type="text"] {
      padding: 8px;
      margin: 5px;
      width: 200px;
    }
    button {
      padding: 10px 20px;
      margin: 5px;
      background: #333;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background: #555;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
    }
    th {
      background: #f5f5f5;
    }
    .message {
      margin: 10px 0;
      padding: 10px;
      border-radius: 4px;
    }
    .success {
      background: #d4edda;
      color: #155724;
    }
    .error {
      background: #f8d7da;
      color: #721c24;
    }
    .availability-list {
      margin: 20px 0;
    }
    .availability-item {
      padding: 10px;
      margin: 5px 0;
      background: #f9f9f9;
      border-radius: 4px;
      display: flex;
      justify-content: space-between;
    }
    .delete-btn {
      background: #dc3545;
    }
  </style>
</head>
<body>
  <h1>Wardiya</h1>

  <!-- Save Availability Section -->
  <div class="section">
    <h2>Save Your Availability</h2>
    <div>
      <label>User ID: </label>
      <input type="text" id="user_id" placeholder="Enter your name or ID" />
      <button onclick="saveAvailability()">Save Availability</button>
    </div>
    <div id="save-message"></div>

    <table>
      <tr>
        <th>Shift</th>
        <th>Sunday</th>
        <th>Monday</th>
        <th>Tuesday</th>
        <th>Wednesday</th>
        <th>Thursday</th>
        <th>Friday</th>
        <th>Saturday</th>
      </tr>
      <tr>
        <th>Morning</th>
        <td><input type="checkbox" data-day="Sunday" data-slot="Morning" /></td>
        <td><input type="checkbox" data-day="Monday" data-slot="Morning" /></td>
        <td><input type="checkbox" data-day="Tuesday" data-slot="Morning" /></td>
        <td><input type="checkbox" data-day="Wednesday" data-slot="Morning" /></td>
        <td><input type="checkbox" data-day="Thursday" data-slot="Morning" /></td>
        <td><input type="checkbox" data-day="Friday" data-slot="Morning" /></td>
        <td><input type="checkbox" data-day="Saturday" data-slot="Morning" /></td>
      </tr>
      <tr>
        <th>Evening</th>
        <td><input type="checkbox" data-day="Sunday" data-slot="Evening" /></td>
        <td><input type="checkbox" data-day="Monday" data-slot="Evening" /></td>
        <td><input type="checkbox" data-day="Tuesday" data-slot="Evening" /></td>
        <td><input type="checkbox" data-day="Wednesday" data-slot="Evening" /></td>
        <td><input type="checkbox" data-day="Thursday" data-slot="Evening" /></td>
        <td><input type="checkbox" data-day="Friday" data-slot="Evening" /></td>
        <td></td>
      </tr>
      <tr>
        <th>Night</th>
        <td><input type="checkbox" data-day="Sunday" data-slot="Night" /></td>
        <td><input type="checkbox" data-day="Monday" data-slot="Night" /></td>
        <td><input type="checkbox" data-day="Tuesday" data-slot="Night" /></td>
        <td><input type="checkbox" data-day="Wednesday" data-slot="Night" /></td>
        <td><input type="checkbox" data-day="Thursday" data-slot="Night" /></td>
        <td><input type="checkbox" data-day="Friday" data-slot="Night" /></td>
        <td><input type="checkbox" data-day="Saturday" data-slot="Night" /></td>
      </tr>
    </table>
  </div>

  <!-- View Availability Section -->
  <div class="section">
    <h2>View Your Availability</h2>
    <div>
      <label>User ID: </label>
      <input type="text" id="view_user_id" placeholder="Enter your name or ID" />
      <button onclick="loadAvailability()">Load My Availability</button>
    </div>
    <div id="view-message"></div>
    <div id="availability-list" class="availability-list"></div>
  </div>

    <!-- Who's on shift? Section -->
    <div class="section">
      <h2>Who's on shift?</h2>
      <div>
        <label>Day and Shift: </label>
        <input type="text" id="view_day_and_shift" placeholder="i.e Monday Morning" />
        <button onclick="findOutWhoIsOnShift()">Let's find out!</button>
      </div>
      <div id="shift-message"></div>
      <div id="who-is-on-shift-list" class="who-is-on-shift-list"></div>
    </div>

  <script>
    // Save availability function
    async function saveAvailability() {
      const userId = document.getElementById("user_id").value.trim();
      if (!userId) {
        showMessage("save-message", "Please enter a User ID", false);
        return;
      }

      // Get all checked checkboxes
      const checkboxes = document.querySelectorAll("table input[type='checkbox']:checked");
      if (checkboxes.length === 0) {
        showMessage("save-message", "Please select at least one time slot", false);
        return;
      }

      // Save each selected slot
      try {
        for (const checkbox of checkboxes) {
          const day = checkbox.getAttribute("data-day");
          const timeSlot = checkbox.getAttribute("data-slot");

          const formData = new FormData();
          formData.append("user_id", userId);
          formData.append("day", day);
          formData.append("time_slot", timeSlot);

          const response = await fetch("/api/availability", {
            method: "POST",
            body: formData
          });

          if (!response.ok) {
            throw new Error("Failed to save");
          }
        }

        showMessage("save-message", "Availability saved successfully!", true);
        // Clear checkboxes
        checkboxes.forEach(cb => cb.checked = false);
      } catch (error) {
        showMessage("save-message", "Error saving availability", false);
      }
    }

    // View availability function
    async function loadAvailability() {
      const userId = document.getElementById("view_user_id").value.trim();
      if (!userId) {
        showMessage("view-message", "Please enter a User ID", false);
        return;
      }

      try {
        const response = await fetch(`/api/availability/${encodeURIComponent(userId)}`);
        if (!response.ok) {
          throw new Error("Failed to load");
        }

        const data = await response.json();
        displayAvailability(data);
        showMessage("view-message", "", true);
      } catch (error) {
        showMessage("view-message", "Error loading availability", false);
        document.getElementById("availability-list").innerHTML = "";
      }
    }

        // Let's find out who's on shift function
        async function findOutWhoIsOnShift() {
      const dayAndShift = document.getElementById("view_day_and_shift").value.trim();
      const parts = dayAndShift.split(" ");  //split to day and shift
      const day = parts[0]; 
      const shift = parts[1];
      if (!dayAndShift) {
        showMessage("shift-message", "Please enter a day and shift", false);
        return;
      }

      try {
        const response = await fetch(`/api/availability/${encodeURIComponent(day)}/${encodeURIComponent(shift)}`);
        if (!response.ok) {
          throw new Error("Failed to load");
        }

        const data = await response.json();
        showMessage("shift-message", "", true);
      } catch (error) {
        showMessage("shift-message", "Error loading shift owner info", false);
        document.getElementById("who-is-on-shift-list").innerHTML = "";
      }
    }

    // Display availability list
    function displayAvailability(items) {
      const listDiv = document.getElementById("availability-list");
      
      if (items.length === 0) {
        listDiv.innerHTML = "<p>No availability saved yet.</p>";
        return;
      }

      let html = "";
      for (const item of items) {
        html += `
          <div class="availability-item">
            <span><strong>${item.day}</strong> - ${item.time_slot}</span>
            <button class="delete-btn" onclick="deleteAvailability(${item.id})">Delete</button>
          </div>
        `;
      }
      listDiv.innerHTML = html;
    }

    // Delete availability function
    async function deleteAvailability(id) {
      try {
        const response = await fetch(`/api/availability/${id}`, {
          method: "DELETE"
        });

        if (!response.ok) {
          throw new Error("Failed to delete");
        }

        // Reload the list
        const userId = document.getElementById("view_user_id").value.trim();
        if (userId) {
          loadAvailability();
        }
      } catch (error) {
        showMessage("view-message", "Error deleting availability", false);
      }
    }

    // Show message helper
    function showMessage(elementId, message, isSuccess) {
      const msgDiv = document.getElementById(elementId);
      if (!message) {
        msgDiv.innerHTML = "";
        msgDiv.className = "";
        return;
      }
      msgDiv.innerHTML = message;
      msgDiv.className = "message " + (isSuccess ? "success" : "error");
    }
  </script>
</body>
</html>
